---
import ThemeToggle from "@/components/ThemeToggle.astro";
import { cn } from "@/lib/utils";

const ITEMS = [
  {
    label: "Services",
    href: "#services",
    dropdownItems: [
      {
        title: "Brand Documentaries",
        href: "/#brand-documentaries",
        description:
          "8-15 minute films that explain who you are, what you've built, and why it matters",
      },
      {
        title: "Recruitment Films",
        href: "/#recruitment-films",
        description:
          "Compelling videos that attract the right talent to your organization",
      },
      {
        title: "Investor Pitches",
        href: "/#investor-pitches",
        description:
          "Films that explain your value proposition better than any pitch deck",
      },
    ],
  },
  { label: "Portfolio", href: "/portfolio" },
  { label: "About", href: "/about" },
  { label: "Blog", href: "/blog" },
  { label: "FAQ", href: "/faq" },
  { label: "Contact", href: "/contact" },
];

const { pathname = "" } = Astro.props;
---

<nav
  id="main-nav"
  class={cn(
    "bg-background/70 absolute left-1/2 z-50 w-[min(90%,700px)] -translate-x-1/2 rounded-4xl border backdrop-blur-md transition-all duration-300",
    "top-5 lg:top-12",
  )}
>
  <div class="flex items-center justify-between px-6 py-3">
    <a href="/" class="flex shrink-0 items-center gap-2">
      <img
        src="/logo-coalbanks.svg"
        alt="logo"
        width={94}
        height={18}
        class="dark:invert"
      />
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden lg:flex items-center gap-1.5">
      {ITEMS.map((link) => (
        <div class="relative group">
          {link.dropdownItems ? (
            <button class="flex items-center gap-1 px-1.5 py-1 text-sm font-medium transition-opacity hover:opacity-75 focus:outline-none">
              {link.label}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="size-3 rotate-90"
              >
                <path d="m9 18 6-6-6-6"></path>
              </svg>
            </button>
            <div class="invisible absolute left-1/2 top-full -translate-x-1/2 pt-2 opacity-0 transition-all group-hover:visible group-hover:opacity-100">
              <ul class="w-[400px] space-y-2 rounded-xl border bg-background/95 p-4 shadow-lg backdrop-blur-sm">
                {link.dropdownItems.map((item) => (
                  <li>
                    <a
                      href={item.href}
                      class="group/item block rounded-md p-3 leading-none no-underline transition-colors hover:bg-accent hover:text-accent-foreground"
                    >
                      <div class="space-y-1.5 transition-transform duration-300 group-hover/item:translate-x-1">
                        <div class="text-sm font-medium leading-none">
                          {item.title}
                        </div>
                        <p class="text-muted-foreground line-clamp-2 text-sm leading-snug">
                          {item.description}
                        </p>
                      </div>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ) : (
            <a
              href={link.href}
              class={cn(
                "px-1.5 py-1 text-sm font-medium transition-opacity hover:opacity-75",
                pathname === link.href && "text-muted-foreground"
              )}
            >
              {link.label}
            </a>
          )}
        </div>
      ))}
    </div>

    <!-- Auth & Toggles -->
    <div class="flex items-center gap-2.5">
      <ThemeToggle />
      <a href="/login" class="hidden lg:block">
        <button class="h-9 px-4 py-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
          Login
        </button>
      </a>
      <!-- Mobile Toggle -->
      <button
        id="mobile-menu-toggle"
        class="text-muted-foreground relative flex size-8 lg:hidden items-center justify-center focus:outline-none"
        aria-label="Toggle menu"
      >
        <div class="relative w-[18px] h-[14px]">
          <span class="line absolute block h-0.5 w-full rounded-full bg-current transition-all duration-300 ease-in-out top-0"></span>
          <span class="line absolute block h-0.5 w-full rounded-full bg-current transition-all duration-300 ease-in-out top-[6px]"></span>
          <span class="line absolute block h-0.5 w-full rounded-full bg-current transition-all duration-300 ease-in-out top-[12px]"></span>
        </div>
      </button>
    </div>
  </div>

  <!-- Mobile Menu Content -->
  <div
    id="mobile-menu"
    class="bg-background invisible fixed inset-x-0 top-[calc(100%+1rem)] flex -translate-y-4 flex-col rounded-2xl border p-6 opacity-0 shadow-xl transition-all duration-300 ease-in-out lg:hidden"
  >
    <nav class="divide-border flex flex-1 flex-col divide-y">
      {ITEMS.map((link) => (
        <div class="mobile-item py-4 first:pt-0 last:pb-0">
          {link.dropdownItems ? (
            <>
              <button class="dropdown-trigger flex w-full items-center justify-between text-base font-medium text-foreground focus:outline-none">
                {link.label}
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="chevron size-4 transition-transform duration-200"
                >
                    <path d="m9 18 6-6-6-6"></path>
                </svg>
              </button>
              <div class="dropdown-content max-h-0 overflow-hidden opacity-0 transition-all duration-300">
                <div class="bg-muted/50 mt-4 space-y-3 rounded-lg p-4">
                  {link.dropdownItems.map((item) => (
                    <a
                      href={item.href}
                      class="group block rounded-md p-2 transition-colors hover:bg-accent"
                    >
                      <div class="transition-transform duration-200 group-hover:translate-x-1">
                        <div class="font-medium text-primary">
                          {item.title}
                        </div>
                        <p class="mt-1 text-sm text-muted-foreground">
                          {item.description}
                        </p>
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            </>
          ) : (
            <a
              href={link.href}
              class={cn(
                "block text-base font-medium text-foreground transition-colors hover:text-foreground/80",
                pathname === link.href && "text-muted-foreground"
              )}
            >
              {link.label}
            </a>
          )}
        </div>
      ))}
    </nav>
  </div>
</nav>

<script>
  function initNav() {
    const toggle = document.getElementById('mobile-menu-toggle');
    const menu = document.getElementById('mobile-menu');
    const lines = toggle?.querySelectorAll('.line');

    if (!toggle || !menu || !lines) return;

    let isOpen = false;

    toggle.addEventListener('click', () => {
      isOpen = !isOpen;
      
      // Update Menu Visibility
      if (isOpen) {
        menu.classList.remove('invisible', '-translate-y-4', 'opacity-0');
        menu.classList.add('visible', 'translate-y-0', 'opacity-100');
        
        // Transform Hamburger to X
        lines[0].classList.add('rotate-45', 'translate-y-[6px]');
        lines[1].classList.add('opacity-0');
        lines[2].classList.add('-rotate-45', '-translate-y-[6px]');
      } else {
        menu.classList.add('invisible', '-translate-y-4', 'opacity-0');
        menu.classList.remove('visible', 'translate-y-0', 'opacity-100');
        
        // Reset X to Hamburger
        lines[0].classList.remove('rotate-45', 'translate-y-[6px]');
        lines[1].classList.remove('opacity-0');
        lines[2].classList.remove('-rotate-45', '-translate-y-[6px]');
      }
    });

    // Dropdown Logic for Mobile
    const dropdownTriggers = document.querySelectorAll('.dropdown-trigger');
    dropdownTriggers.forEach(trigger => {
      trigger.addEventListener('click', () => {
        const content = trigger.nextElementSibling as HTMLElement;
        const chevron = trigger.querySelector('.chevron');
        const isSelfOpen = content.classList.contains('max-h-[1000px]');

        // Close all other dropdowns
        document.querySelectorAll('.dropdown-content').forEach(c => {
           c.classList.remove('mt-4', 'max-h-[1000px]', 'opacity-100');
           c.classList.add('max-h-0', 'opacity-0');
        });
        document.querySelectorAll('.chevron').forEach(cv => cv.classList.remove('rotate-90'));

        if (!isSelfOpen) {
          content.classList.remove('max-h-0', 'opacity-0');
          content.classList.add('mt-4', 'max-h-[1000px]', 'opacity-100');
          chevron?.classList.add('rotate-90');
        }
      });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      if (isOpen && !menu.contains(target) && !toggle.contains(target)) {
        toggle.click();
      }
    });

    // Close menu on navigation
    menu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        if (isOpen) toggle.click();
      });
    });
  }

  // Initialize on load and on view swaps (for View Transitions)
  initNav();
  document.addEventListener('astro:after-swap', initNav);
</script>
